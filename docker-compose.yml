version: '3.8'
services:
    cdnmsredis:
        container_name: cdnmsredis
        command: redis-server --requirepass blahpikachublahpotato
        image: redislabs/rejson:1.0.4
        networks:
            - cdnms
        ports:
            - 6381:6381
    cdnmsserver:
        container_name: cdnmsserver
        depends_on:
            - cdnmsredis
            - cdnmscertbot
        build: ./server
        command: python3 -u /server/main.py
        environment:
            PORT: '8283'
            REDISPWD: blahpikachublahpotatoq
            TLSCERT: '/etc/letsencrypt/live/cdnms.derekwang.dev/fullchain.pem'
            TLSKEY: '/etc/letsencrypt/live/cdnms.derekwang.dev/privkey.pem'
        ports:
            - '8283:8283'
        volumes:
            - certbot-etc:/etc/letsencrypt
            - certbot-var:/var/lib/letsencrypt
    cdnmscertbot:
        container_name: certbot
        command: certonly --standalone --email sentientoranges@gmail.com --agree-tos --keep --no-eff-email -d cdnms.derekwang.dev
        image: certbot/certbot
        networks:
            - cdnms
        ports:
            - 80:80
        volumes:
            - certbot-etc:/etc/letsencrypt
            - certbot-var:/var/lib/letsencrypt
networks:
    cdnms:
volumes:
    certbot-etc:
    certbot-var: